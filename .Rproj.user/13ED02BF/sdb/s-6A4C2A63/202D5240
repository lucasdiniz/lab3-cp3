{
    "collab_server" : "",
    "contents" : "---\ntitle: \"lab3-cp2\"\ndate: \"27 de junho de 2017\"\noutput: \n  html_document: \n    fig_width: 10\n---\n\n##Segredos escondidos nos departamentos da UFCG\nNesta análise iremos brincar um um pouco com dados sobre as unidades acadêmicas da Universidade Federal de Campina Grande. Mais especificamente, utilizaremos os seguintes dados:\n\n*UORG*: Unidade acadêmica em questão.<br>\n*Outro*: Representa a quantidade de funcionários da unidade acadêmica que não são professores.<br>\n*idade_75perc*: 75 percentil do tempo de serviço público dos servidores.<br>\n*prof20*: Representa a quantidade professores da unidade acadêmica em jornada de 20 horas.<br>\n*prof40*: Representa a quantidade professores da unidade acadêmica em jornada de 40 horas ou em dedicação exclusiva.<br>\n\n\n```{r, message=FALSE, warning=FALSE}\n\nlibrary('tidyverse')\nlibrary('plotly')\nlibrary('ggplot2')\nlibrary('broom')\nlibrary('GGally')\n\ndados = read_csv(file = \"dados.csv\") \n\ndados_filtrados <- dados %>% \n  \n  mutate(prof20 = `Professor 20h`,\n         prof40 = `Professor 40h ou DE`,\n         UORG = UORG_LOTACAO\n         ) %>%\n  select(-`Professor 20h`, \n         -`Professor 40h ou DE`, \n         -idade_25perc,\n         -idade_mediana,\n         -UORG_LOTACAO) %>%\n  filter(complete.cases(dados))\n\n```\nPara ter uma noção melhor das relações entre as variáveis, utilizaremos um *descritivo express* que irá deixar claro se houver alguma correlação óbvia nos dados.\n\n```{r}\ndados_filtrados %>% \n    select(-UORG) %>% \n    ggpairs(size = .5, \n            lower = list(continuous = wrap(\"points\", size = .5, alpha = 0.3)))\n```\n\nObservando o *descritivo express* percebemos de cara que existe uma correlação média-forte entre as variáveis *Outro* e *idade_75perc* com valor de 0,606. Isso nos leva a entender que quantos mais funcionários não-professores, maior será o tempo de serviço público dos servidores (em geral) nessa unidade acadêmica. Será que isso é verdade? Vamos agrupar os dados e observar se vemos algum padrão.\n\n<br>\nPara embasar um pouco mais o agrupamento utilizei a estratégia de comparar:\n\n1 - A distância entre o centro dos clusters e o centro dos dados.\n\n2 - A distância entre cada ponto e o centro dos dados.\n\nCom base na proporção dessas duas medidas é possível determinar um bom valor para o número de grupos, uma vez que quando a proporção entre as duas medidas para de aumentar não vale mais a pena aumentar o número de grupos.\n\n```{r}\nhow_many_groups = tibble(groups = 1:15) %>% \n    group_by(groups) %>% \n    do(\n        kmeans(dados_filtrados %>% select(idade_75perc), \n               centers = .$groups, \n               nstart = 20) %>% glance()\n    )\n\nhow_many_groups %>% \n    ggplot(aes(x = groups, y = betweenss / totss)) + \n    geom_line() + \n    geom_point()\n\n```\n\nCom base no gráfico acima decidi que __5 grupos__ seria uma boa quantidade para essa análise. E com a quantidade de grupos em mãos já é possível rodar o algoritmo _kmeans_ e perceber o que os dados podem nos mostrar. Nessa análise resolvi utilizar apenas uma dimensão, o 75 percentil do tempo de serviço público dos servidores.\n\n```{r}\n\ndados_filtrados_km <- dados_filtrados %>% select(idade_75perc) %>% kmeans(centers = 5, nstart = 20)\n\ndados_filtrados_agrupado = dados_filtrados_km %>% augment(dados_filtrados)\n\ndados_filtrados_km %>% \n    augment(dados_filtrados) %>% \n    gather(key = \"variável\", value = \"valor\", -UORG, -.cluster) %>% \n    ggplot(aes(x = `variável`, y = valor, group = UORG, colour = .cluster, colors=\"Set2\")) + \n    geom_line(alpha = .2) + \n    facet_wrap(~ .cluster, scales =\"free_x\") \n\n```\n<h3>Observando os grupos econtrados</h3>\n```{r}\n\nplot_ly(\n        dados_filtrados_agrupado, \n        x = ~Outro,\n        y = ~idade_75perc,\n        color = ~as.character(.cluster),\n        type=\"scatter\",\n        mode=\"markers\",\n        colors = \"Set1\",\n        text = ~paste(\"<b>\",UORG, \"</b><br>\", \"<b>Profs. 20 horas: </b>\", prof20, \"<br><b>Profs. 40 horas:</b> \", prof40,\"<br><b>Servidores: </b>\", Outro, \"<br><b>75-percentil do tempo de serviço: </b>\", format(round(idade_75perc, 2), nsmall=2)),\n        hoverinfo = \"text\"\n        ) \n\n```\n\n###Interpretações sobre os grupos encontrados\n\nInterpretando o gráfico de coordenadas paralelas podemos confirmar o que já suspeitavamos anteriormente, a quantidade de funcionários não-professores tem sim grande influência no tempo de serviço dos servidores dessa unidade, o que nos leva a inferir que os funcionários administrativos dos departamentos são em geral mais antigos na universidade que os professores.\n\nInteressante ainda notar o _grupo 5_, onde o 75 percentil do tempo de serviço público é bastante baixo quando comparado aos outros grupos (assim como a quantidade de servidores/professores). Mais estranho ainda é que todos as 3 unidades acadêmicas nesse grupo possuem apenas _1 professor_. Vejamos as unidades presentes no grupo 5.\n\n```{r}\nprint(as.data.frame(dados_filtrados_agrupado %>% filter(.cluster == 5)))\n```\n\nObservando a variável *idade_75perc* mostrada nos dados percebemos que temos servidores com mais de 2 anos de serviço nesses departamentos, ou seja essas unidades acadêmicas já não são tão novas assim. Então por que será que temos tão poucos funcionários/professores nelas? Será que está faltando recursos para fazer contratações? Fica aqui o questionamento...\n<br>\n\n###Agora utilizando PCA\nEncontrando os componentes com base nas variáveis originais:\n\n```{r}\n\ndados_pca = dados_filtrados %>% column_to_rownames('UORG') %>% prcomp(scale=FALSE)\n\n```\n\nA relação entre os componentes encontrados e as variáveis originais\n\n\n```{r}\n\nprint(as.data.frame(dados_pca$rotation))\n\n```\n\nPodemos ainda ver quanta variância é capturada por cada PC:\n\n```{r}\ntidy(dados_pca, \"pcs\") %>% \n    ggplot(aes(x = PC, y = cumulative, label = cumulative)) + \n    geom_line() + \n    geom_point() + \n    geom_text(vjust = 1, hjust = -.1)\n```\n\nAgora vamos tentar achar a mesma estrutura de grupos que achamos usando K-means, mas dessa vez com as variáveis PC.\n\n```{r}\nau <- augment(dados_pca, dados_filtrados_agrupado)\n    \n plot_ly(\n          au,\n          x = ~.fittedPC2,\n          y = ~.fittedPC4,\n          color = ~as.character(.cluster),\n          type = \"scatter\",\n          mode = \"markers\",\n          colors = \"Set1\",\n          text = ~paste(\"<b>\",UORG, \"</b><br>\", \"<b>Profs. 20 horas: </b>\", prof20, \"<br><b>Profs. 40 horas:</b> \", prof40,\"<br><b>Servidores: </b>\", Outro, \"<br><b>75-percentil do tempo de serviço: </b>\", format(round(idade_75perc, 2), nsmall=2)),\n          hoverinfo = \"text\"\n  )\n\n```\n",
    "created" : 1500606966310.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3861972188",
    "id" : "202D5240",
    "lastKnownWriteTime" : 1500607238,
    "last_content_update" : 1500607238810,
    "path" : "~/Desktop/ad1/lab3-cp3/lab3-cp3.Rmd",
    "project_path" : "lab3-cp3.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}